<%# locals: show_devise_links: false %>
<% show_links = local_assigns.fetch(:show_devise_links, false) %>

<div class="flash-stack">
  <% flash.each do |kind, msg| %>
    <% next if msg.blank? || kind.to_s == "swal" %>

    <%# --- Detecta a mensagem de "pendente de aprovação" (Devise) --- %>
    <% pending_text_i18n = I18n.t('devise.registrations.signed_up_but_inactive', default: nil) %>
    <% msg_text          = (msg.respond_to?(:to_str) ? msg : msg.to_s).strip %>
    <% is_pending_notice = (kind.to_s == "notice") && (
                              (pending_text_i18n.present? && msg_text == pending_text_i18n) ||
                              msg_text.include?("pendente de aprovação")
                            ) %>

    <%# --- Classe Bootstrap do alerta --- %>
    <% bs_class =
      if is_pending_notice
        "alert-warning" # força amarelo
      else
        case kind.to_s
        when "notice"  then "alert-success"
        when "alert"   then "alert-warning"
        when "warning" then "alert-warning"
        when "error"   then "alert-danger"
        else                "alert-info"
        end
      end
    %>

    <%# --- Ícone FontAwesome --- %>
    <% icon_class =
      if is_pending_notice || kind.to_s.in?(%w[alert warning])
        "fa-circle-exclamation"
      elsif kind.to_s == "error"
        "fa-circle-xmark"
      elsif kind.to_s == "notice"
        "fa-circle-check"
      else
        "fa-circle-info"
      end
    %>

    <div class="alert <%= bs_class %> shadow-sm mb-2 d-flex align-items-start"
        role="alert"
        data-controller="flash"
        data-flash-timeout-value="5000"
        <%= 'data-flash-sticky-value="true"' if is_pending_notice %>>
      <div class="me-2 pt-1">
        <i class="fa-solid <%= icon_class %>"></i>
      </div>
      <div class="flex-grow-1"><%= msg.respond_to?(:html_safe) ? msg.html_safe : msg %></div>
      <button type="button"
        class="btn-close ms-3"
        aria-label="Fechar"
        data-action="flash#close">
      </button>
    </div>
  <% end %>

  <%# --- Erros de validação do resource (ex.: Devise forms) --- %>
  <% if defined?(resource) && resource.respond_to?(:errors) && resource.errors.any? %>
    <div class="alert alert-danger shadow-sm mb-2"
         role="alert"
         data-controller="flash"
         data-flash-timeout-value="8000">
      <strong>
        <%= t("errors.messages.not_saved",
              count: resource.errors.count,
              resource: resource.class.model_name.human.downcase) %>
      </strong>
      <ul class="mb-0 mt-2">
        <% resource.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
</div>

<%# --- Links úteis do Devise (opcional) --- %>
<% if show_links && defined?(devise_mapping) && devise_mapping %>
  <div class="mt-3 small text-muted">
    <% if controller_name != 'sessions' %>
      <%= link_to "Entrar", new_session_path(resource_name) %><br>
    <% end %>

    <% if devise_mapping.registerable? && controller_name != 'registrations' %>
      <%= link_to "Criar conta", new_registration_path(resource_name) %><br>
    <% end %>

    <% if devise_mapping.recoverable? && controller_name != 'passwords' && controller_name != 'registrations' %>
      <%= link_to "Esqueceu sua senha?", new_password_path(resource_name) %><br>
    <% end %>

    <% if devise_mapping.confirmable? && controller_name != 'confirmations' %>
      <%= link_to "Não recebeu instruções de confirmação?", new_confirmation_path(resource_name) %><br>
    <% end %>

    <% if devise_mapping.lockable? && resource_class.unlock_strategy_enabled?(:email) && controller_name != 'unlocks' %>
      <%= link_to "Não recebeu instruções de desbloqueio?", new_unlock_path(resource_name) %><br>
    <% end %>
  </div>
<% end %>
