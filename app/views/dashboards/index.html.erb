<!-- ENVOLVA A PÁGINA COM O FUNDO (opcional, mas recomendado) -->
<div class="page-bg">  <!-- <- adicionado -->
  <%= render "shared/navbar" %>
  <%= render "shared/platform_nav" %>


<div class="container py-4">
  <h2 class="mb-4">Dashboard</h2>

<%= form_with url: dashboards_upload_path,
              method: :post,
              multipart: true,
              data: { turbo: false, loading: true },
              local: true do %>

      <div class="row g-3">
        <!-- Pedidos -->
        <div class="col-md-6">
          <div class="upload-card">
            <input
              type="file"
              id="orders_file"
              name="orders_file"
              accept=".xlsx,.xls,.csv"
              class="visually-hidden"
              onchange="const f=this.files[0]; const el=document.getElementById('orders_file_name'); if(el){ el.textContent=f?f.name:'Nenhum arquivo selecionado'; this.labels[0]?.classList.toggle('has-file', !!f); }"
            />

            <label for="orders_file" class="upload-tile" data-drop-for="orders_file">
              <div class="icon">
                <%= image_tag "PedidosICON.svg",
                              alt: "Pedidos",
                              class: "icon-img",
                              width: 28, height: 28 %>
              </div>
              <div class="texts">
                <div class="title">Pedidos (.xlsx/.csv)</div>
                <div class="hint">Deve conter <b>“Receita estimada de mercadorias”</b></div>
                <div class="filename" id="orders_file_name">Nenhum arquivo selecionado</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Faturas -->
        <div class="col-md-6">
          <div class="upload-card">
            <input
              type="file"
              id="invoices_file"
              name="invoices_file"
              accept=".xlsx,.xls,.csv"
              class="visually-hidden"
              onchange="const f=this.files[0]; const el=document.getElementById('invoices_file_name'); if(el){ el.textContent=f?f.name:'Nenhum arquivo selecionado'; this.labels[0]?.classList.toggle('has-file', !!f); }"
            />
            <label for="invoices_file" class="upload-tile" data-drop-for="invoices_file">
              <div class="icon">
                <%= image_tag "PagamentoICON.svg",
                              alt: "Pagamentos",
                              class: "icon-img",
                              width: 28, height: 28 %>
              </div>
              <div class="texts">
                <div class="title">Faturas/Pagamentos (.xlsx/.csv)</div>
                <div class="hint">Deve conter <b>“Valor a receber”</b></div>
                <div class="filename" id="invoices_file_name">Nenhum arquivo selecionado</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <div class="mt-3 d-flex justify-content-between">
        <%= submit_tag "Processar", class: "btn btn-primary mb-3" %>
    <% end %>


      <%= button_to "Verificar Pendentes",
                    dashboards_load_from_db_path,
                    method: :post,
                    form: { data: { turbo: false, loading: true }, class: "d-inline" },
                    class: "btn btn-primary mb-3" %>
    </div>

    <% if @summary.present? %>
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card neon-card text-center kpi-card">
            <div class="card-body">
              <div class="h6 text-muted">Total de pedidos</div>
              <div class="h3"><%= @summary[:total_pedidos] %></div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card neon-card text-center kpi-card">
            <div class="card-body">
              <div class="h6 text-muted">Valor faturado</div>
              <div class="h3">R$ <%= number_with_precision(@summary[:valor_faturado], precision: 2, delimiter: ".", separator: ",") %></div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card neon-card text-center kpi-card">
            <div class="card-body">
              <div class="h6 text-muted">Pedidos pendentes</div>
              <div class="h3 text-warning"><%= @summary[:pedidos_pendentes] %></div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card neon-card text-center kpi-card">
            <div class="card-body">
              <div class="h6 text-muted">Valor pendente</div>
              <div class="h3 text-danger">R$ <%= number_with_precision(@summary[:valor_pendente], precision: 2, delimiter: ".", separator: ",") %></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card neon-card">
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle table-neon table-stacked">
            <thead>
              <tr>
                <th>Número do pedido</th>
                <th>Plataforma</th>
                <th class="text-end">Valor</th>
                <th class="text-center">Dias vencidos</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% @rows.each do |r| %>
                <tr class="<%= 'table-warning' if r['pendente'] %>">
                  <td data-label="Número do pedido"><%= r['numero_pedido'] %></td>
                  <td data-label="Plataforma"><%= r['plataforma'] %></td>
                  <td data-label="Valor" class="text-end">
                    R$ <%= number_with_precision(r['valor'], precision: 2, delimiter: ".", separator: ",") %>
                  </td>
                  <td data-label="Dias vencidos" class="text-center text-md-center text-start">
                    <%= r['dias_vencidos'] %>
                  </td>
                  <td data-label="Status"><%= r['status'] %></td>
                </tr>
              <% end %>

              <% if @rows.blank? %>
                <tr class="empty-row">
                  <td colspan="5" class="text-center text-muted">Nenhum pedido com mais de 90 dias.</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </div>
</div> <!-- /.page-bg -->
