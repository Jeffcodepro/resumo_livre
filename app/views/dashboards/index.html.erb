<div class="page-bg">
  <%= render "shared/navbar" %>
  <%= render "shared/platform_nav" %>

<div class="container py-4">
  <h2 class="mb-4">Dashboard</h2>

<%= form_with url: dashboards_upload_path,
              method: :post,
              multipart: true,
              data: { controller: "loading", action: "submit->loading#submit" },
              local: true do %>

      <div class="row g-3">
        <!-- Pedidos -->
        <div class="col-md-6">
          <div class="upload-card">
            <input
              type="file"
              id="orders_file"
              name="orders_file[]"
              multiple
              accept=".xlsx,.xls,.csv"
              class="visually-hidden"
              onchange="(function(input){
                const files = Array.from(input.files || []);
                const el = document.getElementById('orders_file_name');
                if (el) el.textContent = files.length
                  ? (files.length === 1 ? files[0].name : `${files.length} arquivos selecionados`)
                  : 'Nenhum arquivo selecionado';
                input.labels && input.labels[0] && input.labels[0].classList.toggle('has-file', files.length > 0);
              })(this)"
            />

            <label for="orders_file" class="upload-tile" data-drop-for="orders_file">
              <div class="icon">
                <%= image_tag "PedidosICON.svg", alt: "Pedidos", class: "icon-img", width: 28, height: 28 %>
              </div>
              <div class="texts">
                <div class="title">Pedidos (.xlsx/.csv)</div>
                <div class="hint">Deve conter <b>“Receita estimada de mercadorias”</b></div>
                <div class="filename" id="orders_file_name">Nenhum arquivo selecionado</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Faturas -->
        <div class="col-md-6">
          <div class="upload-card">
            <input
              type="file"
              id="invoices_file"
              name="invoices_file[]"
              multiple
              accept=".xlsx,.xls,.csv"
              class="visually-hidden"
              onchange="(function(input){
                const files = Array.from(input.files || []);
                const el = document.getElementById('invoices_file_name');
                if (el) el.textContent = files.length
                  ? (files.length === 1 ? files[0].name : `${files.length} arquivos selecionados`)
                  : 'Nenhum arquivo selecionado';
                input.labels && input.labels[0] && input.labels[0].classList.toggle('has-file', files.length > 0);
              })(this)"
            />
            <label for="invoices_file" class="upload-tile" data-drop-for="invoices_file">
              <div class="icon">
                <%= image_tag "PagamentoICON.svg", alt: "Pagamentos", class: "icon-img", width: 28, height: 28 %>
              </div>
              <div class="texts">
                <div class="title">Faturas/Pagamentos (.xlsx/.csv)</div>
                <div class="hint">Deve conter <b>“Valor a receber”</b></div>
                <div class="filename" id="invoices_file_name">Nenhum arquivo selecionado</div>
              </div>
            </label>
          </div>
        </div>

    <div class="mt-3 d-flex justify-content-between">
      <%= button_tag type: "submit",
            class: "btn btn-primary mb-3 has-spinner",
            data:  { loading_text: "Importando e processando planilhas…" } do %>
        <i class="fa-solid fa-spinner fa-spin btn-spinner" aria-hidden="true"></i>
        <span class="btn-label">Processar</span>
      <% end %>
    <% end %>


      <%= button_to dashboards_load_from_db_path,
          method: :post,
          form:  { data: { controller: "loading",
                          action: "turbo:submit-start->loading#turboSubmitStart submit->loading#submit" },
                  class: "d-inline" },
          class: "btn btn-primary mb-3 has-spinner",
          data:  { loading_text: "Calculando pendências…" } do %>
      <i class="fa-solid fa-spinner fa-spin btn-spinner" aria-hidden="true"></i>
      <span class="btn-label">Verificar Pendentes</span>
    <% end %>
    </div>

    <% if @summary.present? %>
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card neon-card text-center kpi-card">
            <div class="card-body">
              <div class="h6 text-muted">Total de pedidos</div>
              <div class="h3"><%= @summary[:total_pedidos] %></div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card neon-card text-center kpi-card">
            <div class="card-body">
              <div class="h6 text-muted">Valor faturado</div>
              <div class="h3">R$ <%= number_with_precision(@summary[:valor_faturado], precision: 2, delimiter: ".", separator: ",") %></div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card neon-card text-center kpi-card">
            <div class="card-body">
              <div class="h6 text-muted">Pedidos pendentes</div>
              <div class="h3 text-warning"><%= @summary[:pedidos_pendentes] %></div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card neon-card text-center kpi-card">
            <div class="card-body">
              <div class="h6 text-muted">Valor pendente</div>
              <div class="h3 text-danger">R$ <%= number_with_precision(@summary[:valor_pendente], precision: 2, delimiter: ".", separator: ",") %></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card neon-card">
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle table-neon table-stacked">
            <thead>
              <tr>
                <th>Número do pedido</th>
                <th>Plataforma</th>
                <th class="text-end">Valor</th>
                <th class="text-center">Dias vencidos</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% @rows.each do |r| %>
                <tr class="<%= 'table-warning' if r['pendente'] %>">
                  <td data-label="Número do pedido"><%= r['numero_pedido'] %></td>
                  <td data-label="Plataforma"><%= r['plataforma'] %></td>
                  <td data-label="Valor" class="text-end">
                    R$ <%= number_with_precision(r['valor'], precision: 2, delimiter: ".", separator: ",") %>
                  </td>
                  <td data-label="Dias vencidos" class="text-center text-md-center text-start">
                    <%= r['dias_vencidos'] %>
                  </td>
                  <td data-label="Status"><%= r['status'] %></td>
                </tr>
              <% end %>

              <% if @rows.blank? %>
                <tr class="empty-row">
                  <td colspan="5" class="text-center text-muted">Nenhum pedido com mais de 90 dias.</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
    <div class="d-flex justify-content-end mt-3">
      <%= button_to dashboards_export_pdf_path(format: :pdf, download: 1),
            method: :get,
            form:  { target: "_blank",
                    data: { controller: "loading",
                    action: "turbo:submit-start->loading#turboSubmitStart submit->loading#submit" },
                    class: "d-inline" },
            class: "btn btn-primary mb-3 ms-2 has-spinner",
            data:  { loading_text: "Gerando PDF…" } do %>
        <i class="fa-solid fa-spinner fa-spin btn-spinner" aria-hidden="true"></i>
        <span class="btn-label">Exportar pendentes (PDF)</span>
      <% end %>
    </div>
  </div>
</div> <!-- /.page-bg -->
